repos:
  # First: Basic file cleanup (Allow auto-fixes)
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v5.0.0
    hooks:
      - id: trailing-whitespace
      - id: end-of-file-fixer
      - id: fix-byte-order-marker
      - id: mixed-line-ending
      - id: requirements-txt-fixer
      - id: detect-private-key
      - id: detect-aws-credentials

  # Second: Code formatters (Allow auto-fixes)
  - repo: https://github.com/pycqa/isort
    rev: 5.13.2
    hooks:
      - id: isort
        name: isort
        args: [--settings-path=pyproject.toml, --atomic]
        files: \.py$
        types: [python]
        additional_dependencies: [
          'toml'
        ]

  # Third: Security checks with logging (Warning only)
  - repo: https://github.com/PyCQA/bandit
    rev: 1.8.0
    hooks:
      - id: bandit
        name: bandit
        entry: bash -c '
          mkdir -p logs &&
          bandit -r . -c pyproject.toml -f txt -o logs/bandit.log --severity-level all --confidence-level all --ignore-nosec ||
          echo "Security check completed with warnings - Review logs/bandit.log"
          '
        language: python
        types: [python]
        pass_filenames: false
        exclude: ^(tests/|venv/|\.venv/|\.git/|\.pytest_cache/|__pycache__/)

  # Fourth: Linters and validators with logging (Warning only)
  - repo: local
    hooks:
      - id: pylint
        name: pylint
        entry: |
          bash -c '
            mkdir -p logs &&
            TIMESTAMP=$(date +%Y%m%d_%H%M%S) &&
            echo "Linting Report - $(date)" > "logs/linting_report_${TIMESTAMP}.log" &&
            echo -e "\n================================================================================\nPyLint Results\n================================================================================\n" >> "logs/linting_report_${TIMESTAMP}.log" &&
            cd backend &&
            PYTHONPATH=. pylint \
              --output-format=text \
              --msg-template="backend/{path}:{line}: [{msg_id}({symbol}), {obj}] {msg}" \
              --exit-zero \
              app tests \
              >> "../logs/linting_report_${TIMESTAMP}.log" &&
            echo "Linting completed - Review logs/linting_report_${TIMESTAMP}.log for details"
          '
        language: python
        types: [python]
        require_serial: true
        additional_dependencies: [
          'pylint',
          'pyyaml',
          'fastapi',
          'pydantic',
          'pydantic-settings',
          'sqlalchemy',
          'firebase-admin',
          'uvicorn',
          'mangum',
          'email-validator',
          'bcrypt',
          'openai',
          'pytest',
          'pytest-cov',
          'pytest-asyncio',
          'httpx'
        ]
        pass_filenames: false

      # Add dependency update and test check (Warning only)
      - id: update-dependencies
        name: Update and Test Dependencies
        entry: bash -c 'python scripts/update_dependencies.py || echo "Dependency update completed with warnings - Manual review required"'
        language: python
        pass_filenames: false
        require_serial: true
        stages: [pre-push]

  # Fifth: File type specific checks (Allow auto-fixes)
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v5.0.0
    hooks:
      - id: check-yaml
        args: [--unsafe, --allow-multiple-documents]
      - id: check-json
        exclude: ^frontend/tsconfig.*\.json$
      - id: check-added-large-files
        args: [--maxkb=500]
      - id: debug-statements
      - id: check-docstring-first
      - id: check-executables-have-shebangs
      - id: check-merge-conflict
      - id: check-illegal-windows-names
      - id: check-symlinks
      - id: destroyed-symlinks


  # Sixth: Infrastructure formatters and validators (Allow auto-fixes)
  - repo: https://github.com/antonbabenko/pre-commit-terraform
    rev: v1.96.2
    hooks:
      - id: terraform_fmt
        args: [--args=-write=true]

  # Last: Custom validation hooks (Warning only)
  - repo: local
    hooks:
      - id: validate-working-directories
        name: Validate Pipeline Working Directories
        entry: bash -c 'python scripts/validate_pipeline_dirs.py || echo "Pipeline directory validation completed with warnings - Manual review required"'
        language: python
        files: ^\.github/workflows/.*\.yml$
        additional_dependencies: ['pyyaml']

      # Add log file aggregator (Warning only)
      - id: add-missing-docstrings
        name: Add Missing Docstrings
        entry: bash -c 'python scripts/add_missing_docstrings.py || echo "Docstring check completed with warnings - Manual review required"'
        language: python
        types: [python]

      - id: generate-openapi-spec
        name: Generate OpenAPI Specification
        entry: bash -c 'python scripts/generate_openapi_spec.py || echo "OpenAPI spec generation completed with warnings - Manual review required"'
        language: python
        files: ^backend/app/.*\.py$
        pass_filenames: false
        additional_dependencies: [
          'pyyaml',
          'fastapi',
          'pydantic',
          'pydantic-settings',
          'sqlalchemy',
          'firebase-admin',
          'uvicorn',
          'mangum',
          'email-validator',
          'bcrypt',
          'openai'
        ]

      - id: check-openapi-version
        name: Check OpenAPI Version
        entry: bash -c 'python scripts/check_openapi_version.py || echo "OpenAPI version check completed with warnings - Manual review required"'
        language: python
        files: ^backend/app/openapi/specification\.yaml$
        additional_dependencies: ['pyyaml']
